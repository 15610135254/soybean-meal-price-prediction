{% extends 'base.html' %}

{% block title %}模型评估 - 豆粕期货价格预测系统{% endblock %}

{% block head %}
<style>
    .model-card {
        transition: transform 0.3s;
    }
    .model-card:hover {
        transform: translateY(-5px);
    }
    .metrics-table th, .metrics-table td {
        text-align: center;
    }
    .evaluation-log {
        max-height: 300px;
        overflow-y: auto;
        background-color: #f8f9fa;
        font-family: monospace;
        padding: 10px;
        border-radius: 5px;
    }
    /* 控制预测对比图表的大小 */
    #predictionChartContainer {
        height: 400px;
        margin: 0 auto;
        width: 95%;
        position: relative;
    }
    /* 确保图表标题和图例不会太大 */
    #predictionComparisonChart {
        height: 100%;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-speedometer"></i> 模型评估</h2>
            <p class="lead">评估和比较不同深度学习模型的性能</p>
        </div>
        <div class="col-md-4 text-end">
            <button id="runEvaluationBtn" class="btn btn-primary">
                <i class="bi bi-play-circle"></i> 运行评估
            </button>
        </div>
    </div>

    <!-- 模型性能卡片 -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm model-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-diagram-3"></i> MLP 模型</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-4 fw-bold">{{ model_metrics.mlp.accuracy|round(2) }}%</div>
                        <div class="text-muted">准确率</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div class="text-center">
                            <div class="h5">{{ model_metrics.mlp.rmse|round(2) }}</div>
                            <div class="text-muted small">RMSE</div>
                        </div>
                        <div class="text-center">
                            <div class="h5">{{ model_metrics.mlp.mae|round(2) if model_metrics.mlp.mae else 'N/A' }}</div>
                            <div class="text-muted small">MAE</div>
                        </div>
                        <div class="text-center">
                            <div class="h5">{{ model_metrics.mlp.r2|round(4) if model_metrics.mlp.r2 else 'N/A' }}</div>
                            <div class="text-muted small">R²</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm model-card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-cpu"></i> LSTM 模型</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-4 fw-bold">{{ model_metrics.lstm.accuracy|round(2) }}%</div>
                        <div class="text-muted">准确率</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div class="text-center">
                            <div class="h5">{{ model_metrics.lstm.rmse|round(2) }}</div>
                            <div class="text-muted small">RMSE</div>
                        </div>
                        <div class="text-center">
                            <div class="h5">{{ model_metrics.lstm.mae|round(2) if model_metrics.lstm.mae else 'N/A' }}</div>
                            <div class="text-muted small">MAE</div>
                        </div>
                        <div class="text-center">
                            <div class="h5">{{ model_metrics.lstm.r2|round(4) if model_metrics.lstm.r2 else 'N/A' }}</div>
                            <div class="text-muted small">R²</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm model-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-grid-3x3"></i> CNN 模型</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-4 fw-bold">{{ model_metrics.cnn.accuracy|round(2) }}%</div>
                        <div class="text-muted">准确率</div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div class="text-center">
                            <div class="h5">{{ model_metrics.cnn.rmse|round(2) }}</div>
                            <div class="text-muted small">RMSE</div>
                        </div>
                        <div class="text-center">
                            <div class="h5">{{ model_metrics.cnn.mae|round(2) if model_metrics.cnn.mae else 'N/A' }}</div>
                            <div class="text-muted small">MAE</div>
                        </div>
                        <div class="text-center">
                            <div class="h5">{{ model_metrics.cnn.r2|round(4) if model_metrics.cnn.r2 else 'N/A' }}</div>
                            <div class="text-muted small">R²</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- 模型文件列表 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-file-earmark-binary"></i> 模型文件</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#modelFilesCollapse" aria-expanded="true">
                                <i class="bi bi-arrows-expand"></i> 展开/折叠
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="modelFilesCollapse">
                    <div class="card-body">
                        {% if model_files %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>模型类型</th>
                                        <th>文件名</th>
                                        <th>参数量</th>
                                        <th>大小</th>
                                        <th>修改时间</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for file in model_files %}
                                    <tr>
                                        <td>
                                            {% if file.type == 'mlp' %}
                                            <span class="badge bg-primary">MLP</span>
                                            {% elif file.type == 'lstm' %}
                                            <span class="badge bg-success">LSTM</span>
                                            {% elif file.type == 'cnn' %}
                                            <span class="badge bg-info">CNN</span>
                                            {% else %}
                                            <span class="badge bg-secondary">未知</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ file.name }}</td>
                                        <td>{{ file.total_params if file.total_params else 'N/A' }}</td>
                                        <td>{{ file.size }}</td>
                                        <td>{{ file.modified }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 未找到模型文件
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模型比较 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> 模型性能比较</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#modelComparisonCollapse" aria-expanded="true">
                                <i class="bi bi-arrows-expand"></i> 展开/折叠
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="modelComparisonCollapse">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">准确率比较</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="accuracyChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">误差指标比较</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="errorChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive mt-3">
                            <table class="table table-bordered table-hover metrics-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>模型</th>
                                        <th>准确率</th>
                                        <th>RMSE</th>
                                        <th>MAE</th>
                                        <th>R²</th>
                                        <th>参数量</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="badge bg-primary">MLP</span></td>
                                        <td>{{ model_metrics.mlp.accuracy|round(2) }}%</td>
                                        <td>{{ model_metrics.mlp.rmse|round(2) }}</td>
                                        <td>{{ model_metrics.mlp.mae|round(2) if model_metrics.mlp.mae else 'N/A' }}</td>
                                        <td>{{ model_metrics.mlp.r2|round(4) if model_metrics.mlp.r2 else 'N/A' }}</td>
                                        <td>{{ "{:,}".format(model_details.mlp.params) }}</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge bg-success">LSTM</span></td>
                                        <td>{{ model_metrics.lstm.accuracy|round(2) }}%</td>
                                        <td>{{ model_metrics.lstm.rmse|round(2) }}</td>
                                        <td>{{ model_metrics.lstm.mae|round(2) if model_metrics.lstm.mae else 'N/A' }}</td>
                                        <td>{{ model_metrics.lstm.r2|round(4) if model_metrics.lstm.r2 else 'N/A' }}</td>
                                        <td>{{ "{:,}".format(model_details.lstm.params) }}</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge bg-info">CNN</span></td>
                                        <td>{{ model_metrics.cnn.accuracy|round(2) }}%</td>
                                        <td>{{ model_metrics.cnn.rmse|round(2) }}</td>
                                        <td>{{ model_metrics.cnn.mae|round(2) if model_metrics.cnn.mae else 'N/A' }}</td>
                                        <td>{{ model_metrics.cnn.r2|round(4) if model_metrics.cnn.r2 else 'N/A' }}</td>
                                        <td>{{ "{:,}".format(model_details.cnn.params) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 预测与真实数据对比 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> 模型在测试集上的预测性能对比</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#predictionComparisonCollapse" aria-expanded="true">
                                <i class="bi bi-arrows-expand"></i> 展开/折叠
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="predictionComparisonCollapse">
                    <div class="card-body">
                        <div id="predictionChartContainer" style="display: none; height: 400px;">
                            <canvas id="predictionComparisonChart"></canvas>
                        </div>
                        <div id="predictionChartPlaceholder" class="text-center py-5">
                            <p class="text-muted">
                                <i class="bi bi-info-circle me-2"></i>
                                点击"运行评估"按钮查看三种模型在历史测试集上的预测性能对比。系统使用单步预测方法：
                                <br>每次只预测一天，使用真实历史数据作为输入，这种方法更准确，能够更好地反映模型的实际性能。
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 评估日志 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-terminal"></i> 评估日志</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#evaluationLogCollapse" aria-expanded="true">
                                <i class="bi bi-arrows-expand"></i> 展开/折叠
                            </button>
                        </div>
                    </div>
                </div>
                <div class="collapse show" id="evaluationLogCollapse">
                    <div class="card-body">
                        <div id="evaluationLog" class="evaluation-log">
                            <div class="text-muted">点击"运行评估"按钮开始模型评估...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>
{% endblock %}

{% block scripts %}
<!-- 隐藏的模型指标数据 -->
<script id="modelMetricsData" type="application/json">
    {{ model_metrics|tojson }}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();

        const runEvaluationBtn = document.getElementById('runEvaluationBtn');
        const evaluationLog = document.getElementById('evaluationLog');

        function initCharts() {
            try {
                const modelMetricsElement = document.getElementById('modelMetricsData');
                if (!modelMetricsElement) {
                    console.error('找不到模型指标数据元素');
                    return;
                }

                const modelMetrics = JSON.parse(modelMetricsElement.textContent);

                // 准确率比较图表
                const accuracyCtx = document.getElementById('accuracyChart');
                if (accuracyCtx) {
                    new Chart(accuracyCtx, {
                        type: 'bar',
                        data: {
                            labels: ['MLP', 'LSTM', 'CNN'],
                            datasets: [{
                                label: '准确率 (%)',
                                data: [
                                    modelMetrics.mlp.accuracy,
                                    modelMetrics.lstm.accuracy,
                                    modelMetrics.cnn.accuracy
                                ],
                                backgroundColor: [
                                    'rgba(13, 110, 253, 0.7)',
                                    'rgba(25, 135, 84, 0.7)',
                                    'rgba(13, 202, 240, 0.7)'
                                ],
                                borderColor: [
                                    'rgb(13, 110, 253)',
                                    'rgb(25, 135, 84)',
                                    'rgb(13, 202, 240)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `准确率: ${context.raw.toFixed(2)}%`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    min: 90,
                                    max: 100
                                }
                            }
                        }
                    });
                }

                // 误差指标比较图表
                const errorCtx = document.getElementById('errorChart');
                if (errorCtx) {
                    new Chart(errorCtx, {
                        type: 'bar',
                        data: {
                            labels: ['MLP', 'LSTM', 'CNN'],
                            datasets: [{
                                label: 'RMSE',
                                data: [
                                    modelMetrics.mlp.rmse,
                                    modelMetrics.lstm.rmse,
                                    modelMetrics.cnn.rmse
                                ],
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: 'rgb(255, 99, 132)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `RMSE: ${context.raw.toFixed(2)}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('初始化图表时出错:', error);
            }
        }

        let predictionComparisonChart = null;

        function createPredictionComparisonChart(realData, predictions) {
            const chartContainer = document.getElementById('predictionChartContainer');
            const chartPlaceholder = document.getElementById('predictionChartPlaceholder');
            const chartCanvas = document.getElementById('predictionComparisonChart');

            // 检查数据有效性
            if (!realData || !realData.dates || realData.dates.length === 0) {
                chartPlaceholder.innerHTML = '<p class="text-warning"><i class="bi bi-exclamation-triangle me-2"></i>无法获取真实数据</p>';
                chartPlaceholder.style.display = 'block';
                chartContainer.style.display = 'none';
                return;
            }

            const hasAnyPredictions = Object.values(predictions).some(p => p.dates && p.dates.length > 0);
            if (!hasAnyPredictions) {
                chartPlaceholder.innerHTML = '<p class="text-warning"><i class="bi bi-exclamation-triangle me-2"></i>所有模型预测失败</p>';
                chartPlaceholder.style.display = 'block';
                chartContainer.style.display = 'none';
                return;
            }

            chartContainer.style.display = 'block';
            chartPlaceholder.style.display = 'none';

            if (predictionComparisonChart) {
                predictionComparisonChart.destroy();
            }

            // 计算Y轴范围，使用更小的刻度以获得更好的比例
            let allPrices = [...realData.prices];
            for (const model in predictions) {
                if (predictions[model].prices && predictions[model].prices.length > 0) {
                    allPrices = allPrices.concat(predictions[model].prices);
                }
            }

            // 找出最小值和最大值
            const minValue = Math.min(...allPrices);
            const maxValue = Math.max(...allPrices);

            // 计算数据范围
            const dataRange = maxValue - minValue;

            // 使用更小的刻度单位，根据数据范围动态调整
            let stepSize;
            if (dataRange > 500) {
                stepSize = 50; // 大范围使用50的步长
            } else if (dataRange > 200) {
                stepSize = 20; // 中等范围使用20的步长
            } else if (dataRange > 100) {
                stepSize = 10; // 小范围使用10的步长
            } else {
                stepSize = 5;  // 非常小的范围使用5的步长
            }

            // 计算Y轴的最小值和最大值，留出一些边距
            const padding = stepSize * 0.5; // 上下各留出半个步长的空间
            const minPrice = Math.floor((minValue - padding) / stepSize) * stepSize;
            const maxPrice = Math.ceil((maxValue + padding) / stepSize) * stepSize;

            const datasets = [
                {
                    label: '真实数据',
                    data: realData.prices,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                }
            ];

            const modelColors = {
                'mlp': {
                    border: 'rgba(13, 110, 253, 1)',
                    background: 'rgba(13, 110, 253, 0.2)'
                },
                'lstm': {
                    border: 'rgba(25, 135, 84, 1)',
                    background: 'rgba(25, 135, 84, 0.2)'
                },
                'cnn': {
                    border: 'rgba(13, 202, 240, 1)',
                    background: 'rgba(13, 202, 240, 0.2)'
                }
            };

            // 处理预测结果
            for (const [model, prediction] of Object.entries(predictions)) {
                if (prediction.dates && prediction.dates.length > 0) {
                    // 获取模型颜色
                    const modelColor = modelColors[model] || {
                        border: 'rgba(128, 128, 128, 1)',
                        background: 'rgba(128, 128, 128, 0.2)'
                    };

                    // 创建数据集
                    datasets.push({
                        label: `${model.toUpperCase()} 预测`,
                        data: prediction.prices,
                        borderColor: modelColor.border,
                        backgroundColor: modelColor.background,
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    });
                }
            }

            predictionComparisonChart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: realData.dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '三种模型在历史测试集上的预测性能对比',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        subtitle: {
                            display: true,
                            text: '价格单位：元/吨',
                            font: {
                                size: 12
                            },
                            padding: {
                                bottom: 5
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' 元/吨';
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 10
                                },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 6,
                                padding: 8
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '日期',
                                font: {
                                    size: 10
                                }
                            },
                            ticks: {
                                font: {
                                    size: 9
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '价格 (元/吨)',
                                font: {
                                    size: 10
                                }
                            },
                            min: minPrice,
                            max: maxPrice,
                            ticks: {
                                stepSize: stepSize,
                                font: {
                                    size: 9
                                },
                                callback: function(value) {
                                    return value.toFixed(0);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        runEvaluationBtn.addEventListener('click', function() {
            // 显示加载状态
            runEvaluationBtn.disabled = true;
            runEvaluationBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 评估中...';
            evaluationLog.innerHTML = '<div class="text-info">正在运行模型评估，请稍候...</div>';

            fetch('/viz/api/run-evaluation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                runEvaluationBtn.disabled = false;
                runEvaluationBtn.innerHTML = '<i class="bi bi-play-circle"></i> 运行评估';

                if (data.success) {
                    evaluationLog.innerHTML = `
                        <div class="text-success mb-3"><i class="bi bi-check-circle"></i> ${data.message}</div>
                        <div class="mb-2"><strong>评估结果:</strong></div>
                    `;

                    for (const [model, metrics] of Object.entries(data.metrics)) {
                        evaluationLog.innerHTML += `
                            <div class="mb-2">
                                <strong>${model.toUpperCase()} 模型:</strong><br>
                                准确率: ${metrics.accuracy.toFixed(2)}%<br>
                                RMSE: ${metrics.rmse.toFixed(2)}<br>
                                MAE: ${metrics.mae.toFixed(2)}<br>
                                R²: ${metrics.r2.toFixed(4)}<br>
                                MAPE: ${metrics.mape.toFixed(2)}%
                            </div>
                        `;
                    }

                    if (data.real_data && data.predictions) {
                        createPredictionComparisonChart(data.real_data, data.predictions);
                    }
                } else {
                    evaluationLog.innerHTML = `
                        <div class="text-danger"><i class="bi bi-exclamation-triangle"></i> ${data.message}</div>
                    `;
                }
            })
            .catch(error => {
                runEvaluationBtn.disabled = false;
                runEvaluationBtn.innerHTML = '<i class="bi bi-play-circle"></i> 运行评估';
                evaluationLog.innerHTML = `
                    <div class="text-danger"><i class="bi bi-exclamation-triangle"></i> 评估过程中出错: ${error}</div>
                `;
            });
        });
    });
</script>
{% endblock %}
