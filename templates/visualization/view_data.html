{% extends 'base.html' %}

{% block title %}数据可视化 - 豆粕期货价格预测系统{% endblock %}

{% block head %}
    <!-- 引入 jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- 引入 Chart.js 和其他需要的库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        .data-card {
            transition: all 0.3s ease;
        }
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .data-controls {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .prediction-badge {
            font-size: 1.2rem;
            padding: 8px 15px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="bi bi-bar-chart"></i> 豆粕期货数据分析</h2>
            <p class="lead">通过深度学习模型分析历史数据，预测未来价格走势</p>
        </div>
    </div>

    <!-- 数据控制面板 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card data-controls">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <label for="modelSelect" class="form-label">预测模型</label>
                            <select class="form-select" id="modelSelect">
                                <option value="mlp" selected>MLP模型</option>
                                <option value="lstm">LSTM模型</option>
                                <option value="cnn">CNN模型</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" id="applyFiltersBtn">
                                <i class="bi bi-funnel"></i> 预测
                            </button>
                        </div>
                        <!-- 隐藏的元素，保持JavaScript功能正常 -->
                        <div style="display: none;">
                            <select id="timeRangeSelect">
                                <option value="30" selected>最近一个月</option>
                            </select>
                            <select id="predictionRange">
                                <option value="1" selected>1天</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 价格预测卡片 -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card data-card bg-light">
                <div class="card-body text-center">
                    <h5 class="card-title">当前价格</h5>
                    <h2 class="display-5 fw-bold">3,456.00</h2>
                    <p class="text-success">
                        <i class="bi bi-arrow-up"></i> +2.5% (今日)
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card data-card bg-light">
                <div class="card-body text-center">
                    <h5 class="card-title" id="prediction-title">预测收盘价 (明日)</h5>
                    <div id="prediction-loading" class="text-center py-2">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <span class="ms-2">正在预测...</span>
                    </div>
                    <div id="prediction-content" style="display: none;">
                        <h2 class="display-5 fw-bold" id="predicted-price">--</h2>
                        <p class="text-muted" id="predicted-change">
                            <i class="bi bi-dash"></i> --% (预期)
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card data-card bg-light">
                <div class="card-body text-center">
                    <h5 class="card-title">模型准确率</h5>
                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 87%;" aria-valuenow="87" aria-valuemin="0" aria-valuemax="100">87%</div>
                    </div>
                    <p class="text-muted">基于LSTM模型历史表现</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 主图表 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> 豆粕期货价格走势与预测</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <div id="chartLoadingIndicator" class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-3">正在加载图表数据...</p>
                        </div>
                        <canvas id="closingPriceChart" style="display: none;"></canvas>
                    </div>
                    <div class="d-flex justify-content-center mt-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="zoomInBtn">
                                <i class="bi bi-zoom-in"></i> 放大
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="zoomOutBtn">
                                <i class="bi bi-zoom-out"></i> 缩小
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="resetZoomBtn">
                                <i class="bi bi-arrow-counterclockwise"></i> 重置
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 成交量图表 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> 成交量</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="volumeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 技术指标面板 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> RSI_14指标</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="rsiChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> HV_20与ATR_14指标</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="volatilityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MACD指标和OBV指标 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> MACD指标</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="macdChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> OBV指标</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="obvChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据表格和其他指标 -->
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-table"></i> 历史数据</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="dataTable">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>开盘价</th>
                                    <th>最高价</th>
                                    <th>最低价</th>
                                    <th>收盘价</th>
                                    <th>成交量</th>
                                    <th>涨跌幅</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 表格内容将由JavaScript动态生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted">显示 1-5 条，共 120 条</span>
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm">
                                <li class="page-item disabled"><a class="page-link" href="#">上一页</a></li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item"><a class="page-link" href="#">下一页</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> 数据管理</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if session.user_role == 'admin' %}
                        <button class="btn btn-outline-primary mb-3" type="button" data-bs-toggle="modal" data-bs-target="#uploadDataModal">
                            <i class="bi bi-upload"></i> 上传新数据
                        </button>
                        <button class="btn btn-outline-primary mb-3" type="button" data-bs-toggle="modal" data-bs-target="#editDataModal">
                            <i class="bi bi-pencil"></i> 编辑数据
                        </button>
                        <button class="btn btn-outline-danger" type="button" data-bs-toggle="modal" data-bs-target="#deleteDataModal">
                            <i class="bi bi-trash"></i> 删除数据
                        </button>
                        {% else %}
                        <div class="alert alert-secondary">
                            <i class="bi bi-lock"></i> 数据管理功能仅对管理员开放
                        </div>
                        {% endif %}
                    </div>

                    <hr class="my-4">

                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> 数据说明</h6>
                        <p class="mb-0">本系统使用深度学习模型分析豆粕期货历史数据，预测未来价格走势。预测结果仅供参考，不构成投资建议。</p>
                    </div>

                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> 风险提示</h6>
                        <p class="mb-0">期货交易有风险，投资需谨慎。历史数据不代表未来表现，请结合多种因素进行分析决策。</p>
                    </div>
                </div>
            </div>


        </div>
    </div>
</div>

<!-- 上传数据模态框 -->
<div class="modal fade" id="uploadDataModal" tabindex="-1" aria-labelledby="uploadDataModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadDataModalLabel">上传新数据</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadDataForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="dataFile" class="form-label">选择CSV文件</label>
                        <input class="form-control" type="file" id="dataFile" name="file" accept=".csv" required>
                        <div class="form-text">请上传包含日期、开盘价、最高价、最低价、收盘价、成交量等列的CSV文件</div>
                    </div>
                    <div class="alert alert-info">
                        <small>上传后系统将自动处理数据，添加技术指标，并使用新上传的数据进行趋势图显示和预测分析。</small>
                    </div>
                    <div id="uploadStatus" class="d-none">
                        <div class="progress mb-3">
                            <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p id="uploadStatusText" class="text-center"></p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="uploadDataBtn">上传</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑数据模态框 -->
<div class="modal fade" id="editDataModal" tabindex="-1" aria-labelledby="editDataModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDataModalLabel">编辑数据</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="editDate" class="form-label">日期</label>
                        <input type="date" class="form-control" id="editDate">
                    </div>
                    <div class="mb-3">
                        <label for="editOpen" class="form-label">开盘价</label>
                        <input type="number" class="form-control" id="editOpen" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="editHigh" class="form-label">最高价</label>
                        <input type="number" class="form-control" id="editHigh" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="editLow" class="form-label">最低价</label>
                        <input type="number" class="form-control" id="editLow" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="editClose" class="form-label">收盘价</label>
                        <input type="number" class="form-control" id="editClose" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label for="editVolume" class="form-label">成交量</label>
                        <input type="number" class="form-control" id="editVolume">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除数据模态框 -->
<div class="modal fade" id="deleteDataModal" tabindex="-1" aria-labelledby="deleteDataModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteDataModalLabel">删除数据</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="deleteDate" class="form-label">删除日期</label>
                        <input type="date" class="form-control" id="deleteDate">
                    </div>
                    <div class="alert alert-danger">
                        警告：删除操作不可恢复，此操作将删除所选日期的数据。
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 从 Flask 模板获取数据
    let chartData, labels, closingPrices;
    let modelMetrics = {{ model_metrics | safe }};
    let DATA_FILE_PATH = "{{ data_path | safe }}";

    // 记录初始数据源信息
    // console.log("初始数据源:", DATA_FILE_PATH);

    // 调试输出模型指标
    // console.log('模型指标:', modelMetrics);

    try {
        // 检查 chart_data 是否已经是对象
        const rawData = {{ chart_data | safe }};
        // console.log("原始数据类型:", typeof rawData);

        // 如果是字符串，则解析为JSON；如果已经是对象，则直接使用
        chartData = typeof rawData === 'string' ? JSON.parse(rawData) : rawData;
        // console.log("加载的图表数据:", chartData);

        // 检查数据是否有效
        if (chartData && chartData.labels && chartData.closing_prices) {
            labels = chartData.labels;
            closingPrices = chartData.closing_prices;

            // 显示数据加载成功消息
            // console.log(`成功加载数据: ${labels.length} 条记录`);

            // 更新表格中的实际数据
            updateDataTable(chartData);
        } else if (chartData && chartData.error) {
            // 显示错误消息
            // console.error("数据加载错误:", chartData.error);
            alert("数据加载错误: " + chartData.error);

            // 使用空数组作为默认值
            labels = [];
            closingPrices = [];
        } else {
            // console.error("数据格式无效");
            alert("数据格式无效，无法显示图表");

            // 使用空数组作为默认值
            labels = [];
            closingPrices = [];
        }
    } catch (e) {
        // console.error("解析数据时出错:", e);
        alert("解析数据时出错: " + e.message);

        // 使用空数组作为默认值
        labels = [];
        closingPrices = [];
    }

    // 如果没有数据，使用示例数据进行演示
    if (!labels || labels.length === 0) {
        labels = ['2023-04-25', '2023-04-26', '2023-04-27', '2023-04-28', '2023-04-29', '2023-04-30', '2023-05-01', '2023-05-02', '2023-05-03'];
        closingPrices = [3350, 3370, 3380, 3390, 3400, 3390, 3380, 3420, 3456];
        // console.log("使用示例数据进行演示");
    }

    // 预测数据变量
    let predictionLabels = [];
    let predictionPrices = [];
    let currentModel = 'mlp';
    let isLoading = false;

    // 函数：调用后端API进行预测
    async function fetchPrediction(model, days) {
        // 显示加载状态
        isLoading = true;
        showLoadingState(true);

        try {
            // 构建API URL (考虑蓝图前缀)
            const apiUrl = `/viz/api/predict?model=${model}&days=${days}`;

            // 发送请求
            const response = await fetch(apiUrl);

            // 检查响应状态
            if (!response.ok) {
                throw new Error(`预测请求失败: ${response.status} ${response.statusText}`);
            }

            // 解析响应数据
            const data = await response.json();

            // 更新预测数据
            predictionLabels = data.dates || [];
            predictionPrices = data.prices || [];

            // console.log(`成功获取 ${model} 模型的预测数据:`, data);

            return {
                labels: predictionLabels,
                prices: predictionPrices
            };
        } catch (error) {
            // console.error('获取预测数据时出错:', error);
            // 在出错时返回空数据
            return {
                labels: [],
                prices: []
            };
        } finally {
            // 重置加载状态
            isLoading = false;

            // 移除加载指示器
            showLoadingState(false);

            // 确保图表可见
            const chartElement = document.getElementById('closingPriceChart');
            if (chartElement) {
                chartElement.style.display = 'block';
                // console.log('确保图表可见');
            }

            // 强制刷新图表区域
            setTimeout(() => {
                if (closingPriceChart) {
                    closingPriceChart.update();
                    // console.log('强制更新图表');
                }
            }, 100);
        }
    }

    // 显示/隐藏加载状态
    function showLoadingState(show) {
        if (show) {
            // 创建并显示加载指示器
            createLoadingIndicator();
            // console.log('显示加载指示器');
        } else {
            // 移除加载指示器
            removeLoadingIndicator();
            // console.log('移除加载指示器');
        }
    }

    // 创建加载指示器
    function createLoadingIndicator() {
        // 先移除可能存在的旧指示器
        removeLoadingIndicator();

        // 创建新的加载指示器
        const indicator = document.createElement('div');
        indicator.id = 'predictionLoadingIndicator';
        indicator.className = 'position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75';
        indicator.style.zIndex = '1000';
        indicator.innerHTML = `
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <span class="ms-2">正在使用模型预测...</span>
        `;

        // 添加到图表容器
        const chartContainer = document.querySelector('.chart-container');
        if (chartContainer) {
            chartContainer.style.position = 'relative';
            chartContainer.appendChild(indicator);
        }

        return indicator;
    }

    // 移除加载指示器
    function removeLoadingIndicator() {
        const indicator = document.getElementById('predictionLoadingIndicator');
        if (indicator && indicator.parentNode) {
            indicator.parentNode.removeChild(indicator);
            return true;
        }
        return false;
    }

    // 合并历史数据和预测数据
    const allLabels = [...labels, ...predictionLabels];

    // 注释掉移动平均线计算代码
    // const calculateMA = (prices, period) => {
    //     return prices.map((price, i) => {
    //         if (i < period - 1) return null;
    //         const slice = prices.slice(i - period + 1, i + 1);
    //         const sum = slice.reduce((a, b) => a + b, 0);
    //         return sum / period;
    //     });
    // };

    // // 计算MA5和MA20
    // const ma5Data = calculateMA(closingPrices, 5);
    // const ma20Data = calculateMA(closingPrices, 20);

    // 获取 canvas 元素
    const ctx = document.getElementById('closingPriceChart').getContext('2d');

    // 检查Chart.js和插件是否正确加载
    try {
        // console.log("Chart.js 版本:", Chart.version);

        // 检查插件是否已经注册
        const registeredPlugins = Chart.registry.plugins.items;
        // console.log("已注册的插件:", registeredPlugins);

        // 检查是否需要手动注册插件
        const hasAnnotationPlugin = Chart.registry.plugins.get('annotation') !== undefined;
        if (!hasAnnotationPlugin) {
            // console.log("尝试手动注册 annotation 插件");
            if (window.ChartAnnotation) {
                Chart.register(window.ChartAnnotation);
                // console.log("成功注册 annotation 插件");
            } else {
                // console.warn("找不到 ChartAnnotation 对象");
            }
        }

        const hasZoomPlugin = Chart.registry.plugins.get('zoom') !== undefined;
        if (!hasZoomPlugin) {
            // console.log("尝试手动注册 zoom 插件");
            if (window.ChartZoom) {
                Chart.register(window.ChartZoom);
                // console.log("成功注册 zoom 插件");
            } else {
                // console.warn("找不到 ChartZoom 对象");
            }
        }
    } catch (e) {
        // console.error("检查Chart.js插件时出错:", e);
    }

    // 隐藏加载指示器，显示图表
    document.getElementById('chartLoadingIndicator').style.display = 'none';
    document.getElementById('closingPriceChart').style.display = 'block';

    // 页面加载时自动调用预测API
    async function loadInitialPrediction() {
        const initialModel = document.getElementById('modelSelect').value;
        const initialDays = document.getElementById('predictionRange').value;

        // 立即更新预测天数显示，不等待API响应
        const predictionTitle = document.getElementById('prediction-title');
        if (predictionTitle) {
            predictionTitle.textContent = `预测收盘价 (明日)`;
        }

        try {
            // 调用预测API
            const prediction = await fetchPrediction(initialModel, initialDays);

            if (prediction.labels.length > 0 && prediction.prices.length > 0) {
                // 更新图表数据
                closingPriceChart.data.labels = [...initialFilteredData.filteredLabels, ...prediction.labels];

                // 更新历史收盘价数据（在预测部分为null）
                closingPriceChart.data.datasets[0].data = [...initialFilteredData.filteredPrices, ...Array(prediction.labels.length).fill(null)];

                // 更新预测价格数据（在历史部分为null）
                closingPriceChart.data.datasets[1].data = [...Array(initialFilteredData.filteredLabels.length).fill(null), ...prediction.prices];

                // 更新图表
                closingPriceChart.update();

                // 更新预测价格卡片
                const predictedPrice = prediction.prices[prediction.prices.length - 1];

                // 隐藏加载状态，显示预测内容
                document.getElementById('prediction-loading').style.display = 'none';
                document.getElementById('prediction-content').style.display = 'block';

                // 更新预测价格
                const predictedPriceElement = document.getElementById('predicted-price');
                if (predictedPriceElement && predictedPrice) {
                    predictedPriceElement.textContent = predictedPrice.toLocaleString();

                    // 更新预期涨跌幅
                    if (initialFilteredData.filteredPrices.length > 0) {
                        const currentPrice = initialFilteredData.filteredPrices[initialFilteredData.filteredPrices.length - 1];
                        const expectedChangePercent = ((predictedPrice - currentPrice) / currentPrice * 100).toFixed(2);
                        const predictedChangeElement = document.getElementById('predicted-change');

                        if (predictedChangeElement) {
                            if (expectedChangePercent > 0) {
                                predictedChangeElement.innerHTML = `<i class="bi bi-arrow-up"></i> +${expectedChangePercent}% (预期)`;
                                predictedChangeElement.className = 'text-success';
                            } else if (expectedChangePercent < 0) {
                                predictedChangeElement.innerHTML = `<i class="bi bi-arrow-down"></i> ${expectedChangePercent}% (预期)`;
                                predictedChangeElement.className = 'text-danger';
                            } else {
                                predictedChangeElement.innerHTML = `<i class="bi bi-dash"></i> 0.00% (预期)`;
                                predictedChangeElement.className = 'text-muted';
                            }
                        }
                    }
                }

                // 更新预测天数显示
                const predictionTitle = document.getElementById('prediction-title');
                if (predictionTitle) {
                    predictionTitle.textContent = `预测收盘价 (明日)`;
                }
            }
        } catch (error) {
            // console.error('初始预测加载失败:', error);
            showPredictionError('初始预测加载失败，请点击"预测"按钮重试。');
        }
    }

    // 调用初始预测加载函数
    loadInitialPrediction();

    // 根据时间范围过滤数据
    function filterDataByTimeRange(days) {
        /* console.log("开始过滤数据，当前完整数据集信息:", {
            "数据源": DATA_FILE_PATH || "未知",
            "日期数量": labels ? labels.length : 0,
            "日期范围": labels && labels.length > 0 ? labels[0] + " 至 " + labels[labels.length-1] : "无数据"
        }); */

        if (days === 'all' || !labels || labels.length === 0) {
            // console.log("显示全部数据，日期范围:", labels && labels.length > 0 ? labels[0] + " 至 " + labels[labels.length-1] : "无数据");
            return {
                filteredLabels: labels,
                filteredPrices: closingPrices,
                startIndex: 0
            };
        }

        // 将天数转换为整数
        const daysNum = parseInt(days);

        // 确保数据是按日期排序的（从早到晚）
        // 计算开始索引（确保不会小于0）
        const startIndex = Math.max(0, labels.length - daysNum);

        // 过滤数据
        let filteredLabels = labels.slice(startIndex);
        let filteredPrices = closingPrices.slice(startIndex);

        // 检查过滤后的数据是否按日期从早到晚排序
        if (filteredLabels.length > 1 && new Date(filteredLabels[0]) > new Date(filteredLabels[filteredLabels.length-1])) {
            // console.warn("过滤后的数据是倒序的，正在重新排序...");

            // 创建日期和价格的配对数组
            let pairs = filteredLabels.map((label, index) => {
                return {
                    date: label,
                    price: filteredPrices[index]
                };
            });

            // 按日期从早到晚排序
            pairs.sort((a, b) => new Date(a.date) - new Date(b.date));

            // 提取排序后的标签和价格
            filteredLabels = pairs.map(pair => pair.date);
            filteredPrices = pairs.map(pair => pair.price);

            // console.log("过滤数据重新排序后:", {
            //     "第一个日期": filteredLabels[0],
            //     "最后一个日期": filteredLabels[filteredLabels.length-1]
            // });
        }

        /* console.log(`显示最近 ${daysNum} 天数据，过滤后信息:`, {
            "过滤前日期数量": labels.length,
            "过滤后日期数量": filteredLabels.length,
            "过滤后日期范围": filteredLabels.length > 0 ? filteredLabels[0] + " 至 " + filteredLabels[filteredLabels.length-1] : "无数据",
            "过滤后前5个日期": filteredLabels.length > 0 ? filteredLabels.slice(0, Math.min(5, filteredLabels.length)).join(", ") : "无数据",
            "过滤后后5个日期": filteredLabels.length > 0 ? filteredLabels.slice(-Math.min(5, filteredLabels.length)).join(", ") : "无数据"
        }); */

        return {
            filteredLabels,
            filteredPrices,
            startIndex
        };
    }

    // 初始过滤数据（默认显示30天）
    const initialTimeRange = document.getElementById('timeRangeSelect').value;
    const initialFilteredData = filterDataByTimeRange(initialTimeRange);

    // 准备K线图数据
    const ohlcData = [];
    const volumeData = [];

    // 确保所有必要的数据都存在
    if (chartData && chartData.labels && chartData.closing_prices &&
        chartData.opening_prices && chartData.high_prices && chartData.low_prices &&
        chartData.volumes) {

        for (let i = 0; i < chartData.labels.length; i++) {
            // 创建K线数据
            ohlcData.push({
                x: chartData.labels[i],
                o: chartData.opening_prices[i],
                h: chartData.high_prices[i],
                l: chartData.low_prices[i],
                c: chartData.closing_prices[i]
            });

            // 创建成交量数据
            volumeData.push({
                x: chartData.labels[i],
                y: chartData.volumes[i],
                // 根据涨跌设置颜色
                color: i > 0 && chartData.closing_prices[i] >= chartData.closing_prices[i-1] ?
                       'rgba(75, 192, 192, 0.5)' : 'rgba(255, 99, 132, 0.5)'
            });
        }
    }

    // 创建图表
    const closingPriceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: initialFilteredData.filteredLabels,
            datasets: [
                {
                    label: '历史收盘价',
                    data: initialFilteredData.filteredPrices,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    fill: true
                },
                {
                    label: '预测价格',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    tension: 0.1,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                // 只有在插件可用时才启用注释功能
                ...(Chart.registry.plugins.get('annotation') !== undefined ? {
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                xMin: labels.length - 1,
                                xMax: labels.length - 1,
                                borderColor: 'rgb(169, 169, 169)',
                                borderWidth: 2,
                                borderDash: [6, 6],
                                label: {
                                    content: '预测开始',
                                    display: true,
                                    position: 'start'
                                }
                            }
                        }
                    }
                } : {}),

                // 只有在插件可用时才启用缩放功能
                ...(Chart.registry.plugins.get('zoom') !== undefined ? {
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'x'
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'x',
                        }
                    }
                } : {})
            }
        }
    });

    // 创建成交量图表
    const volumeCtx = document.getElementById('volumeChart').getContext('2d');
    const volumeChart = new Chart(volumeCtx, {
        type: 'bar',
        data: {
            labels: initialFilteredData.filteredLabels,
            datasets: [{
                label: '成交量',
                data: chartData && chartData.volumes ?
                      chartData.volumes.slice(Math.max(0, chartData.volumes.length - initialFilteredData.filteredLabels.length)) :
                      [],
                backgroundColor: function(context) {
                    if (!chartData || !chartData.closing_prices) return 'rgba(75, 192, 192, 0.5)';

                    const index = context.dataIndex;
                    const dataLength = initialFilteredData.filteredLabels.length;
                    const dataStartIndex = Math.max(0, chartData.closing_prices.length - dataLength);

                    const actualIndex = dataStartIndex + index;
                    if (actualIndex <= 0 || actualIndex >= chartData.closing_prices.length) return 'rgba(75, 192, 192, 0.5)';

                    return chartData.closing_prices[actualIndex] >= chartData.closing_prices[actualIndex-1] ?
                           'rgba(75, 192, 192, 0.5)' : 'rgba(255, 99, 132, 0.5)';
                },
                borderColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                title: {
                    display: true,
                    text: '成交量趋势'
                }
            },
            scales: {
                x: {
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000000) {
                                return (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return (value / 1000).toFixed(1) + 'K';
                            }
                            return value;
                        }
                    }
                }
            }
        }
    });

    // 更新数据表格
    function updateDataTable(data) {
        // 只有当有足够的数据时才更新表格
        if (!data || !data.labels || data.labels.length < 5) return;

        const tableBody = document.querySelector('.table tbody');
        if (!tableBody) return;

        // 清空表格
        tableBody.innerHTML = '';

        // 获取最近的5条数据
        const lastIndex = data.labels.length - 1;
        const startIndex = Math.max(0, lastIndex - 4);

        // 添加数据行
        for (let i = lastIndex; i >= startIndex; i--) {
            const row = document.createElement('tr');

            // 计算涨跌幅
            const changePercent = i > 0
                ? ((data.closing_prices[i] - data.closing_prices[i-1]) / data.closing_prices[i-1] * 100).toFixed(1)
                : 0;

            const changeClass = changePercent > 0 ? 'text-success' : (changePercent < 0 ? 'text-danger' : '');
            const changeSign = changePercent > 0 ? '+' : '';

            // 设置行内容
            row.innerHTML = `
                <td>${data.labels[i]}</td>
                <td>${data.opening_prices && data.opening_prices[i] ? data.opening_prices[i].toLocaleString() : '-'}</td>
                <td>${data.high_prices && data.high_prices[i] ? data.high_prices[i].toLocaleString() : '-'}</td>
                <td>${data.low_prices && data.low_prices[i] ? data.low_prices[i].toLocaleString() : '-'}</td>
                <td>${data.closing_prices[i].toLocaleString()}</td>
                <td>${data.volumes && data.volumes[i] ? data.volumes[i].toLocaleString() : '-'}</td>
                <td class="${changeClass}">${changeSign}${changePercent}%</td>
            `;

            tableBody.appendChild(row);
        }

        // 更新显示的记录数
        const countDisplay = document.querySelector('.text-muted');
        if (countDisplay) {
            countDisplay.textContent = `显示 ${startIndex+1}-${lastIndex+1} 条，共 ${data.labels.length} 条`;
        }
    }

    // 添加按钮事件监听器
    document.getElementById('zoomInBtn').addEventListener('click', function() {
        try {
            // 检查是否有缩放功能
            if (closingPriceChart.zoom && typeof closingPriceChart.zoom === 'function') {
                closingPriceChart.zoom(1.1);
                // 同步缩放成交量图表
                if (volumeChart.zoom && typeof volumeChart.zoom === 'function') {
                    volumeChart.zoom(1.1);
                }
            } else {
                // console.warn("图表没有 zoom 方法");
            }
        } catch (e) {
            // console.error("缩放操作失败:", e);
        }
    });

    document.getElementById('zoomOutBtn').addEventListener('click', function() {
        try {
            // 检查是否有缩放功能
            if (closingPriceChart.zoom && typeof closingPriceChart.zoom === 'function') {
                closingPriceChart.zoom(0.9);
                // 同步缩放成交量图表
                if (volumeChart.zoom && typeof volumeChart.zoom === 'function') {
                    volumeChart.zoom(0.9);
                }
            } else {
                // console.warn("图表没有 zoom 方法");
            }
        } catch (e) {
            // console.error("缩放操作失败:", e);
        }
    });

    document.getElementById('resetZoomBtn').addEventListener('click', function() {
        try {
            // 检查是否有重置缩放功能
            if (closingPriceChart.resetZoom && typeof closingPriceChart.resetZoom === 'function') {
                closingPriceChart.resetZoom();
                // 同步重置成交量图表
                if (volumeChart.resetZoom && typeof volumeChart.resetZoom === 'function') {
                    volumeChart.resetZoom();
                }
            } else {
                // console.warn("图表没有 resetZoom 方法");
                // 尝试通过重新加载页面来重置
                location.reload();
            }
        } catch (e) {
            // console.error("重置缩放操作失败:", e);
            // 如果重置失败，尝试重新加载页面
            location.reload();
        }
    });

    document.getElementById('applyFiltersBtn').addEventListener('click', async function() {
        // 获取选择的时间范围
        const timeRange = document.getElementById('timeRangeSelect').value;

        // 获取选择的预测模型
        const selectedModel = document.getElementById('modelSelect').value;

        // 预测天数固定为1天
        const predictionDays = '1';

        // 更新当前模型
        currentModel = selectedModel;

        // 根据选择的时间范围过滤数据
        const filteredData = filterDataByTimeRange(timeRange);

        // 更新图表的历史数据部分
        closingPriceChart.data.labels = filteredData.filteredLabels;
        closingPriceChart.data.datasets[0].data = filteredData.filteredPrices;
        closingPriceChart.data.datasets[1].data = [];

        // 先更新图表，显示历史数据
        closingPriceChart.update();

        // 调用后端API获取预测数据
        try {
            const prediction = await fetchPrediction(selectedModel, predictionDays);

            if (prediction.labels.length > 0 && prediction.prices.length > 0) {
                // 更新图表数据，添加预测部分
                closingPriceChart.data.labels = [...filteredData.filteredLabels, ...prediction.labels];

                // 更新历史收盘价数据（在预测部分为null）
                closingPriceChart.data.datasets[0].data = [...filteredData.filteredPrices, ...Array(prediction.labels.length).fill(null)];

                // 更新预测价格数据（在历史部分为null）
                closingPriceChart.data.datasets[1].data = [...Array(filteredData.filteredLabels.length).fill(null), ...prediction.prices];

                // 更新图表
                closingPriceChart.update();

                // 更新预测价格卡片
                const predictedPrice = prediction.prices[prediction.prices.length - 1];

                // 隐藏加载状态，显示预测内容
                document.getElementById('prediction-loading').style.display = 'none';
                document.getElementById('prediction-content').style.display = 'block';

                // 预测天数固定为1天
                const predictionTitle = document.getElementById('prediction-title');
                if (predictionTitle) {
                    predictionTitle.textContent = '预测收盘价 (明日)';
                }

                // 更新预测价格
                const predictedPriceElement = document.getElementById('predicted-price');
                if (predictedPriceElement && predictedPrice) {
                    predictedPriceElement.textContent = predictedPrice.toLocaleString();

                    // 更新预期涨跌幅
                    if (filteredData.filteredPrices.length > 0) {
                        const currentPrice = filteredData.filteredPrices[filteredData.filteredPrices.length - 1];
                        const expectedChangePercent = ((predictedPrice - currentPrice) / currentPrice * 100).toFixed(2);
                        const predictedChangeElement = document.getElementById('predicted-change');

                        if (predictedChangeElement) {
                            if (expectedChangePercent > 0) {
                                predictedChangeElement.innerHTML = `<i class="bi bi-arrow-up"></i> +${expectedChangePercent}% (预期)`;
                                predictedChangeElement.className = 'text-success';
                            } else if (expectedChangePercent < 0) {
                                predictedChangeElement.innerHTML = `<i class="bi bi-arrow-down"></i> ${expectedChangePercent}% (预期)`;
                                predictedChangeElement.className = 'text-danger';
                            } else {
                                predictedChangeElement.innerHTML = `<i class="bi bi-dash"></i> 0.00% (预期)`;
                                predictedChangeElement.className = 'text-muted';
                            }
                        }
                    }
                }
            } else {
                // console.warn('预测API返回了空数据');
                showPredictionError('无法获取预测数据，请稍后再试。');
            }
        } catch (error) {
            // console.error('获取预测数据时出错:', error);
            showPredictionError('获取预测数据时出错: ' + error.message);
        } finally {
            // 移除加载指示器
            showLoadingState(false);

            // 确保图表可见
            const chartElement = document.getElementById('closingPriceChart');
            if (chartElement) {
                chartElement.style.display = 'block';
                // console.log('确保图表可见');
            }

            // 强制刷新图表区域
            setTimeout(() => {
                if (closingPriceChart) {
                    closingPriceChart.update();
                    // console.log('强制更新图表');
                }
            }, 100);
        }

        // console.log(`预测条件: 时间范围=${timeRange}天, 预测模型=${selectedModel}, 预测天数=${predictionDays}天`);

        // 更新模型说明
        updateModelDescription(selectedModel);
    });

    // 更新模型说明函数
    function updateModelDescription(model) {
        let description = '';
        let accuracy = '';

        // 获取模型描述
        switch(model) {
            case 'mlp':
                description = 'MLP (多层感知机) 模型是一种前馈神经网络，能够学习特征之间的非线性关系，适合处理多维特征数据。';
                break;
            case 'lstm':
                description = 'LSTM (长短期记忆网络) 模型擅长捕捉时间序列中的长期依赖关系，对价格趋势变化有较好的预测能力。';
                break;
            case 'cnn':
                description = 'CNN (卷积神经网络) 模型通过卷积层提取局部特征，能够识别时间序列中的模式和趋势，计算效率高。';
                break;
            default:
                description = '请选择预测模型';
        }

        // 从后端获取的模型指标中获取准确率
        // console.log(`获取 ${model} 模型的准确率:`, modelMetrics && modelMetrics[model] ? modelMetrics[model].accuracy : '未找到');

        if (modelMetrics && modelMetrics[model] && modelMetrics[model].accuracy !== undefined) {
            // 使用模型指标中的准确率
            accuracy = modelMetrics[model].accuracy.toFixed(2) + '%';
            // console.log(`使用模型指标中的准确率: ${accuracy}`);
        } else {
            // 如果没有获取到准确率，使用默认值
            switch(model) {
                case 'mlp': accuracy = '97.71%'; break;
                case 'lstm': accuracy = '97.34%'; break;
                case 'cnn': accuracy = '97.25%'; break;
                default: accuracy = 'N/A';
            }
            // console.log(`使用默认准确率: ${accuracy}`);
        }

        // 更新准确率显示
        const accuracyElement = document.querySelector('.progress-bar');
        if (accuracyElement) {
            // 提取准确率数值（去掉百分号）
            const accuracyValue = parseFloat(accuracy.replace('%', ''));
            // 设置进度条宽度（使用整数值）
            accuracyElement.style.width = `${Math.floor(accuracyValue)}%`;
            // 显示准确率（保留一位小数）
            accuracyElement.textContent = `${accuracyValue.toFixed(2)}%`;
            accuracyElement.setAttribute('aria-valuenow', accuracyValue);

            // 更新准确率说明文本
            const accuracyTextElement = document.querySelector('.card-title + .progress + .text-muted');
            if (accuracyTextElement) {
                accuracyTextElement.textContent = `基于${getModelFullName(model)}历史表现`;
            }
        }

        // 添加模型说明到页面
        const modelInfoElement = document.querySelector('.card-body .alert-info p');
        if (modelInfoElement) {
            modelInfoElement.innerHTML = `本系统使用<strong>${getModelFullName(model)}</strong>分析豆粕期货历史数据，预测未来价格走势。${description} 预测结果仅供参考，不构成投资建议。`;
        }
    }

    // 获取模型全名
    function getModelFullName(model) {
        switch(model) {
            case 'mlp':
                return '多层感知机 (MLP) ';
            case 'lstm':
                return '长短期记忆网络 (LSTM) ';
            case 'cnn':
                return '卷积神经网络 (CNN) ';
            default:
                return '深度学习模型';
        }
    }

    // 显示预测错误
    function showPredictionError(errorMessage) {
        // 隐藏加载状态，显示预测内容
        document.getElementById('prediction-loading').style.display = 'none';
        document.getElementById('prediction-content').style.display = 'block';

        // 更新预测价格为错误信息
        const predictedPriceElement = document.getElementById('predicted-price');
        if (predictedPriceElement) {
            predictedPriceElement.textContent = '预测失败';
            predictedPriceElement.style.fontSize = '1.5rem';
            predictedPriceElement.style.color = '#dc3545';
        }

        // 更新预期涨跌幅为错误信息
        const predictedChangeElement = document.getElementById('predicted-change');
        if (predictedChangeElement) {
            predictedChangeElement.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${errorMessage}`;
            predictedChangeElement.className = 'text-danger small';
        }

        // 显示错误提示
        // console.error('预测失败:', errorMessage);
    }

    // 初始化时更新模型说明
    updateModelDescription('mlp');

    // 添加模型选择的事件监听器
    document.getElementById('modelSelect').addEventListener('change', function() {
        const selectedModel = this.value;
        updateModelDescription(selectedModel);
    });

    // 添加时间范围选择的事件监听器（保留但不再需要用户交互）
    const timeRangeSelect = document.getElementById('timeRangeSelect');
    if (timeRangeSelect) {
        timeRangeSelect.addEventListener('change', function() {
            // 获取选择的时间范围
            const timeRange = this.value;

            // 根据选择的时间范围过滤数据
            const filteredData = filterDataByTimeRange(timeRange);

            // 更新所有图表的数据
            updateAllCharts(filteredData);

            // 自动点击预测按钮
            document.getElementById('applyFiltersBtn').click();
        });
    }

    // 更新所有图表的函数
    function updateAllCharts(filteredData) {
        // 更新主价格图表
        if (closingPriceChart) {
            closingPriceChart.data.labels = filteredData.filteredLabels;
            closingPriceChart.data.datasets[0].data = filteredData.filteredPrices;
            closingPriceChart.update();
        }

        // 更新成交量图表
        if (volumeChart && chartData && chartData.volumes) {
            volumeChart.data.labels = filteredData.filteredLabels;
            volumeChart.data.datasets[0].data = chartData.volumes.slice(
                Math.max(0, chartData.volumes.length - filteredData.filteredLabels.length)
            );
            volumeChart.update();
        }

        // 更新RSI_14图表
        const rsiChart = Chart.getChart(document.getElementById('rsiChart'));
        if (rsiChart && chartData && chartData.rsi) {
            rsiChart.data.labels = filteredData.filteredLabels;
            rsiChart.data.datasets[0].data = chartData.rsi.slice(
                Math.max(0, chartData.rsi.length - filteredData.filteredLabels.length)
            );
            // 更新超买超卖线
            rsiChart.data.datasets[1].data = Array(filteredData.filteredLabels.length).fill(70);
            rsiChart.data.datasets[2].data = Array(filteredData.filteredLabels.length).fill(30);
            rsiChart.update();
        }

        // 更新HV_20与ATR_14图表
        const volatilityChart = Chart.getChart(document.getElementById('volatilityChart'));
        if (volatilityChart && chartData) {
            volatilityChart.data.labels = filteredData.filteredLabels;

            // 更新HV_20数据
            if (chartData.hv20 && volatilityChart.data.datasets[0]) {
                volatilityChart.data.datasets[0].data = chartData.hv20.slice(
                    Math.max(0, chartData.hv20.length - filteredData.filteredLabels.length)
                );
            }

            // 更新ATR_14数据
            if (chartData.atr14 && volatilityChart.data.datasets[1]) {
                volatilityChart.data.datasets[1].data = chartData.atr14.slice(
                    Math.max(0, chartData.atr14.length - filteredData.filteredLabels.length)
                );
            }

            volatilityChart.update();
        }

        // 更新MACD图表
        const macdChart = Chart.getChart(document.getElementById('macdChart'));
        if (macdChart && chartData && chartData.MACD) {
            macdChart.data.labels = filteredData.filteredLabels;

            // 更新MACD数据
            macdChart.data.datasets[0].data = chartData.MACD.slice(
                Math.max(0, chartData.MACD.length - filteredData.filteredLabels.length)
            );

            macdChart.update();
        }

        // 更新OBV图表
        const obvChart = Chart.getChart(document.getElementById('obvChart'));
        if (obvChart && chartData && chartData.obv) {
            obvChart.data.labels = filteredData.filteredLabels;
            obvChart.data.datasets[0].data = chartData.obv.slice(
                Math.max(0, chartData.obv.length - filteredData.filteredLabels.length)
            );
            obvChart.update();
        }
    }

    // 预测天数固定为1天
    document.getElementById('predictionRange').value = '1';
    const predictionTitle = document.getElementById('prediction-title');
    if (predictionTitle) {
        predictionTitle.textContent = '预测收盘价 (明日)';
    }

    // 创建RSI_14指标图表
    if (chartData && chartData.rsi) {
        const rsiCtx = document.getElementById('rsiChart').getContext('2d');
        const rsiChart = new Chart(rsiCtx, {
            type: 'line',
            data: {
                labels: initialFilteredData.filteredLabels,
                datasets: [
                    {
                        label: 'RSI_14',
                        data: chartData.rsi.slice(Math.max(0, chartData.rsi.length - initialFilteredData.filteredLabels.length)),
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    },
                    {
                        label: '超买线 (70)',
                        data: Array(initialFilteredData.filteredLabels.length).fill(70),
                        borderColor: 'rgba(255, 99, 132, 0.7)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    },
                    {
                        label: '超卖线 (30)',
                        data: Array(initialFilteredData.filteredLabels.length).fill(30),
                        borderColor: 'rgba(75, 192, 192, 0.7)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    title: {
                        display: true,
                        text: 'RSI_14指标'
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        min: 0,
                        max: 100,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });
    }

    // 创建MACD指标图表
    if (chartData && chartData.MACD) {
        const macdCtx = document.getElementById('macdChart').getContext('2d');
        const macdChart = new Chart(macdCtx, {
            type: 'line',
            data: {
                labels: initialFilteredData.filteredLabels,
                datasets: [
                    {
                        label: 'MACD',
                        data: chartData.MACD.slice(Math.max(0, chartData.MACD.length - initialFilteredData.filteredLabels.length)),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    title: {
                        display: true,
                        text: 'MACD指标'
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });
    }

    // 创建HV_20与ATR_14指标图表
    if (chartData) {
        const volatilityCtx = document.getElementById('volatilityChart').getContext('2d');

        // 准备数据
        const datasets = [];

        // 添加历史波动率数据
        if (chartData.hv20) {
            datasets.push({
                label: 'HV_20',
                data: chartData.hv20.slice(Math.max(0, chartData.hv20.length - initialFilteredData.filteredLabels.length)),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                borderWidth: 2,
                tension: 0.1,
                fill: false,
                yAxisID: 'y'
            });
        }

        // 添加ATR数据
        if (chartData.atr14) {
            datasets.push({
                label: 'ATR_14',
                data: chartData.atr14.slice(Math.max(0, chartData.atr14.length - initialFilteredData.filteredLabels.length)),
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                borderWidth: 2,
                tension: 0.1,
                fill: false,
                yAxisID: 'y1'
            });
        }

        // 创建图表
        const volatilityChart = new Chart(volatilityCtx, {
            type: 'line',
            data: {
                labels: initialFilteredData.filteredLabels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    title: {
                        display: true,
                        text: 'HV_20与ATR_14指标'
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'HV_20'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'ATR_14'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });
    }

    // 创建OBV指标图表
    if (chartData && chartData.obv) {
        const obvCtx = document.getElementById('obvChart').getContext('2d');
        const obvChart = new Chart(obvCtx, {
            type: 'line',
            data: {
                labels: initialFilteredData.filteredLabels,
                datasets: [
                    {
                        label: 'OBV',
                        data: chartData.obv.slice(Math.max(0, chartData.obv.length - initialFilteredData.filteredLabels.length)),
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    title: {
                        display: true,
                        text: 'OBV指标'
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                if (Math.abs(value) >= 1000000) {
                                    return (value / 1000000).toFixed(1) + 'M';
                                } else if (Math.abs(value) >= 1000) {
                                    return (value / 1000).toFixed(1) + 'K';
                                }
                                return value;
                            }
                        }
                    }
                }
            }
        });
    }



    // 文件上传功能
    document.getElementById('uploadDataBtn').addEventListener('click', function() {
        // 获取表单和文件
        const form = document.getElementById('uploadDataForm');
        const fileInput = document.getElementById('dataFile');

        // 检查是否选择了文件
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('请选择要上传的CSV文件');
            return;
        }

        // 检查文件类型
        const file = fileInput.files[0];
        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert('请选择CSV格式的文件');
            return;
        }

        // 创建FormData对象
        const formData = new FormData();
        formData.append('file', file);

        // 显示上传状态
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadStatusText = document.getElementById('uploadStatusText');

        uploadStatus.classList.remove('d-none');
        uploadProgressBar.style.width = '0%';
        uploadStatusText.textContent = '准备上传...';

        // 禁用上传按钮
        const uploadBtn = document.getElementById('uploadDataBtn');
        uploadBtn.disabled = true;

        // 发送请求
        fetch('/viz/api/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            uploadProgressBar.style.width = '100%';

            if (!response.ok) {
                if (response.status === 500) {
                    // 尝试解析错误消息
                    return response.json().then(data => {
                        throw new Error(data.error || `上传失败: ${response.status} ${response.statusText}`);
                    }).catch(err => {
                        // 如果JSON解析失败，使用原始错误
                        throw new Error(`上传失败: ${response.status} ${response.statusText}`);
                    });
                } else {
                    throw new Error(`上传失败: ${response.status} ${response.statusText}`);
                }
            }

            uploadStatusText.textContent = '上传成功，正在处理数据...';

            // 安全地解析JSON
            return response.text().then(text => {
                try {
                    // 尝试解析JSON
                    return JSON.parse(text);
                } catch (e) {
                    // console.error('JSON解析错误:', e);
                    // console.log('原始响应:', text);
                    throw new Error('服务器返回的数据格式无效');
                }
            });
        })
        .then(data => {
            if (data.success) {
                // 上传成功
                uploadStatusText.textContent = `文件 ${data.filename} 上传成功，共 ${data.rows} 条记录`;

                // 更新图表数据
                if (data.chart_data) {
                    // 更新全局数据
                    chartData = data.chart_data;
                    labels = data.chart_data.labels;
                    closingPrices = data.chart_data.closing_prices;

                    // 根据时间范围过滤数据
                    const timeRange = document.getElementById('timeRangeSelect').value;
                    const filteredData = filterDataByTimeRange(timeRange);

                    // 更新所有图表
                    updateAllCharts(filteredData);

                    // 清除预测数据
                    closingPriceChart.data.datasets[1].data = [];
                    closingPriceChart.update();

                    // 更新数据表格
                    updateDataTable(chartData);

                    // 更新价格预测卡片
                    updatePricePredictionCards();

                    // 自动触发预测
                    document.getElementById('applyFiltersBtn').click();

                    // 显示成功消息
                    showNotification('数据上传成功，图表和预测已使用新数据更新', 'success');

                    // 关闭模态框
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('uploadDataModal'));
                        if (modal) {
                            modal.hide();
                        }
                    }, 1500);
                }
            } else {
                // 上传失败
                uploadStatusText.textContent = data.error || '上传失败';
                uploadProgressBar.classList.remove('bg-primary');
                uploadProgressBar.classList.add('bg-danger');
                showNotification('上传失败: ' + (data.error || '未知错误'), 'danger');
            }
        })
        .catch(error => {
            // console.error('上传文件时出错:', error);
            uploadStatusText.textContent = `上传失败: ${error.message}`;
            uploadProgressBar.classList.remove('bg-primary');
            uploadProgressBar.classList.add('bg-danger');
            showNotification('上传失败: ' + error.message, 'danger');
        })
        .finally(() => {
            // 启用上传按钮
            uploadBtn.disabled = false;
        });
    });

    // 显示通知消息
    function showNotification(message, type = 'success') {
        // 创建通知元素
        const notification = document.createElement('div');
        notification.className = `toast align-items-center text-white bg-${type} border-0`;
        notification.setAttribute('role', 'alert');
        notification.setAttribute('aria-live', 'assertive');
        notification.setAttribute('aria-atomic', 'true');

        notification.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;

        // 创建或获取通知容器
        let container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(container);
        }

        // 添加通知到容器
        container.appendChild(notification);

        // 显示通知
        const toast = new bootstrap.Toast(notification, { delay: 5000 });
        toast.show();

        // 通知关闭后移除元素
        notification.addEventListener('hidden.bs.toast', function() {
            notification.remove();
        });
    }

    // 更新价格预测卡片
    function updatePricePredictionCards() {
        if (closingPrices && closingPrices.length > 0) {
            // 当前价格
            const currentPrice = closingPrices[closingPrices.length - 1];
            const currentPriceElement = document.querySelector('.data-card:nth-child(1) .display-5');
            if (currentPriceElement) {
                currentPriceElement.textContent = currentPrice.toLocaleString();
            }

            // 计算今日涨跌幅
            if (closingPrices.length > 1) {
                const yesterdayPrice = closingPrices[closingPrices.length - 2];
                const changePercent = ((currentPrice - yesterdayPrice) / yesterdayPrice * 100).toFixed(1);
                const changeElement = document.querySelector('.data-card:nth-child(1) .text-success');

                if (changeElement) {
                    if (changePercent > 0) {
                        changeElement.innerHTML = `<i class="bi bi-arrow-up"></i> +${changePercent}% (今日)`;
                        changeElement.className = 'text-success';
                    } else if (changePercent < 0) {
                        changeElement.innerHTML = `<i class="bi bi-arrow-down"></i> ${changePercent}% (今日)`;
                        changeElement.className = 'text-danger';
                    } else {
                        changeElement.innerHTML = `<i class="bi bi-dash"></i> 0.0% (今日)`;
                        changeElement.className = 'text-muted';
                    }
                }
            }

            // 预测价格
            if (predictionPrices && predictionPrices.length > 0) {
                const predictedPrice = predictionPrices[predictionPrices.length - 1];
                const predictedPriceElement = document.querySelector('.data-card:nth-child(2) .display-5');

                if (predictedPriceElement) {
                    predictedPriceElement.textContent = predictedPrice.toLocaleString();
                }

                // 计算预期涨跌幅
                const expectedChangePercent = ((predictedPrice - currentPrice) / currentPrice * 100).toFixed(2);
                const expectedChangeElement = document.querySelector('.data-card:nth-child(2) .text-success');

                if (expectedChangeElement) {
                    if (expectedChangePercent > 0) {
                        expectedChangeElement.innerHTML = `<i class="bi bi-arrow-up"></i> +${expectedChangePercent}% (预期)`;
                        expectedChangeElement.className = 'text-success';
                    } else if (expectedChangePercent < 0) {
                        expectedChangeElement.innerHTML = `<i class="bi bi-arrow-down"></i> ${expectedChangePercent}% (预期)`;
                        expectedChangeElement.className = 'text-danger';
                    } else {
                        expectedChangeElement.innerHTML = `<i class="bi bi-dash"></i> 0.00% (预期)`;
                        expectedChangeElement.className = 'text-muted';
                    }
                }
            }
        }
    }

    // 调用函数更新价格预测卡片
    updatePricePredictionCards();

    // 编辑数据功能
    let currentEditDate = null;

    // 为表格中的行添加点击事件，打开编辑模态框
    function addRowClickHandlers() {
        const tableRows = document.querySelectorAll('#dataTable tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('click', function() {
                // 获取行中的数据
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    // 获取日期和价格数据
                    const date = cells[0].textContent;
                    const open = cells[1].textContent ? parseFloat(cells[1].textContent.replace(/,/g, '')) : '';
                    const high = cells[2].textContent ? parseFloat(cells[2].textContent.replace(/,/g, '')) : '';
                    const low = cells[3].textContent ? parseFloat(cells[3].textContent.replace(/,/g, '')) : '';
                    const close = cells[4].textContent ? parseFloat(cells[4].textContent.replace(/,/g, '')) : '';
                    const volume = cells[5].textContent ? parseInt(cells[5].textContent.replace(/,/g, '')) : '';

                    // 填充编辑表单
                    document.getElementById('editDate').value = date;
                    document.getElementById('editOpen').value = open;
                    document.getElementById('editHigh').value = high;
                    document.getElementById('editLow').value = low;
                    document.getElementById('editClose').value = close;
                    document.getElementById('editVolume').value = volume;

                    // 保存当前编辑的日期
                    currentEditDate = date;

                    // 打开编辑模态框
                    const editModal = new bootstrap.Modal(document.getElementById('editDataModal'));
                    editModal.show();
                }
            });
        });
    }

    // 保存编辑按钮点击事件
    document.getElementById('saveEditBtn').addEventListener('click', async function() {
        // 获取编辑表单中的数据
        const date = currentEditDate;
        const open = document.getElementById('editOpen').value;
        const high = document.getElementById('editHigh').value;
        const low = document.getElementById('editLow').value;
        const close = document.getElementById('editClose').value;
        const volume = document.getElementById('editVolume').value;

        // 验证数据
        if (!date || !close) {
            showNotification('日期和收盘价是必填字段', 'danger');
            return;
        }

        try {
            // 显示加载状态
            showNotification('正在保存数据...', 'info');

            // 发送编辑请求
            const response = await fetch('/viz/api/edit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    date,
                    open: open ? parseFloat(open) : null,
                    high: high ? parseFloat(high) : null,
                    low: low ? parseFloat(low) : null,
                    close: parseFloat(close),
                    volume: volume ? parseInt(volume) : null
                })
            });

            // 解析响应
            const data = await response.json();

            if (data.success) {
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('editDataModal'));
                if (modal) {
                    modal.hide();
                }

                // 更新图表数据
                if (data.chart_data) {
                    // 保存编辑前的数据信息，用于比较
                    const oldLabelsFirst = labels && labels.length > 0 ? labels[0] : "无数据";
                    const oldLabelsLast = labels && labels.length > 0 ? labels[labels.length-1] : "无数据";
                    const oldLabelsLength = labels ? labels.length : 0;

                    // 更新全局数据，但保持使用相同的数据源
                    chartData = data.chart_data;
                    labels = data.chart_data.labels;
                    closingPrices = data.chart_data.closing_prices;

                    // 详细记录数据变化，检查是否更换了数据集
                    // console.log("编辑前数据信息:", {
                    //     "日期数量": oldLabelsLength,
                    //     "日期范围": oldLabelsFirst + " 至 " + oldLabelsLast,
                    //     "前5个日期": labels && labels.length >= 5 ? labels.slice(0, 5).join(", ") : "无足够数据",
                    //     "后5个日期": labels && labels.length >= 5 ? labels.slice(-5).join(", ") : "无足够数据"
                    // });

                    // console.log("编辑后数据信息:", {
                    //     "日期数量": labels.length,
                    //     "日期范围": labels[0] + " 至 " + labels[labels.length-1],
                    //     "前5个日期": labels.slice(0, 5).join(", "),
                    //     "后5个日期": labels.slice(-5).join(", ")
                    // });

                    // 检查数据集是否被更换（通过比较日期范围的起始日期）
                    if (oldLabelsFirst !== labels[0]) {
                        // console.warn("警告：数据集的起始日期发生了变化，可能更换了数据源！");
                        // console.warn("原始起始日期: " + oldLabelsFirst + ", 新起始日期: " + labels[0]);
                    } else {
                        // console.log("数据集的起始日期未变化，仍然使用相同的数据源");
                    }

                    // 根据时间范围过滤数据
                    const timeRange = document.getElementById('timeRangeSelect').value;
                    const filteredData = filterDataByTimeRange(timeRange);

                    // 检查数据是否按日期从早到晚排序
                    // console.log("更新图表前检查数据排序:", {
                    //     "第一个日期": filteredData.filteredLabels[0],
                    //     "最后一个日期": filteredData.filteredLabels[filteredData.filteredLabels.length-1]
                    // });

                    // 确保数据是按日期从早到晚排序的
                    let sortedLabels = [...filteredData.filteredLabels];
                    let sortedPrices = [...filteredData.filteredPrices];

                    // 如果发现数据是倒序的（最后一个日期早于第一个日期），则进行排序
                    if (new Date(sortedLabels[0]) > new Date(sortedLabels[sortedLabels.length-1])) {
                        // console.warn("检测到数据倒序，正在重新排序...");

                        // 创建日期和价格的配对数组
                        let pairs = sortedLabels.map((label, index) => {
                            return {
                                date: label,
                                price: sortedPrices[index]
                            };
                        });

                        // 按日期从早到晚排序
                        pairs.sort((a, b) => new Date(a.date) - new Date(b.date));

                        // 提取排序后的标签和价格
                        sortedLabels = pairs.map(pair => pair.date);
                        sortedPrices = pairs.map(pair => pair.price);

                        // console.log("重新排序后:", {
                        //     "第一个日期": sortedLabels[0],
                        //     "最后一个日期": sortedLabels[sortedLabels.length-1]
                        // });
                    }

                    // 更新所有图表（使用确保正确排序的数据）
                    // 创建一个包含排序后数据的对象，与filterDataByTimeRange返回的格式相同
                    const sortedData = {
                        filteredLabels: sortedLabels,
                        filteredPrices: sortedPrices,
                        startIndex: filteredData.startIndex
                    };

                    // 更新所有图表
                    updateAllCharts(sortedData);

                    // 清除预测数据
                    closingPriceChart.data.datasets[1].data = [];
                    closingPriceChart.update();

                    // 更新数据表格
                    updateDataTable(chartData);

                    // 更新价格预测卡片
                    updatePricePredictionCards();

                    // 自动触发预测，使用相同的数据源
                    document.getElementById('applyFiltersBtn').click();

                    // 显示成功消息
                    showNotification('数据编辑成功，图表和预测已更新', 'success');
                }
            } else {
                // 显示错误消息
                showNotification('编辑失败: ' + (data.error || '未知错误'), 'danger');
            }
        } catch (error) {
            // console.error('编辑数据时出错:', error);
            showNotification('编辑失败: ' + error.message, 'danger');
        }
    });

    // 删除数据按钮点击事件
    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
        // 获取日期
        const deleteDate = document.getElementById('deleteDate').value;

        // 验证数据
        if (!deleteDate) {
            showNotification('删除日期是必填字段', 'danger');
            return;
        }

        try {
            // 显示加载状态
            showNotification('正在删除数据...', 'info');

            // 发送删除请求
            const response = await fetch('/viz/api/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    date: deleteDate
                })
            });

            // 解析响应
            const data = await response.json();

            if (data.success) {
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteDataModal'));
                if (modal) {
                    modal.hide();
                }

                // 更新图表数据
                if (data.chart_data) {
                    // 更新全局数据
                    chartData = data.chart_data;
                    labels = data.chart_data.labels;
                    closingPrices = data.chart_data.closing_prices;

                    // 根据时间范围过滤数据
                    const timeRange = document.getElementById('timeRangeSelect').value;
                    const filteredData = filterDataByTimeRange(timeRange);

                    // 更新所有图表
                    updateAllCharts(filteredData);

                    // 清除预测数据
                    closingPriceChart.data.datasets[1].data = [];
                    closingPriceChart.update();

                    // 更新数据表格
                    updateDataTable(chartData);

                    // 更新价格预测卡片
                    updatePricePredictionCards();

                    // 自动触发预测
                    document.getElementById('applyFiltersBtn').click();

                    // 显示成功消息
                    showNotification(data.message + '，图表和预测已更新', 'success');
                }
            } else {
                // 显示错误消息
                showNotification('删除失败: ' + (data.error || '未知错误'), 'danger');
            }
        } catch (error) {
            // console.error('删除数据时出错:', error);
            showNotification('删除失败: ' + error.message, 'danger');
        }
    });

    // 更新数据表格函数
    function updateDataTable(chartData) {
        if (!chartData || !chartData.labels || !chartData.closing_prices) {
            // console.error('无法更新数据表格：数据无效');
            return;
        }

        // 获取表格元素
        const tableBody = document.querySelector('#dataTable tbody');
        if (!tableBody) {
            // console.error('无法找到数据表格的tbody元素');
            return;
        }

        // 清空表格
        tableBody.innerHTML = '';

        // 每页显示的记录数
        const pageSize = 5;

        // 总记录数
        const totalRecords = chartData.labels.length;

        // 总页数
        const totalPages = Math.ceil(totalRecords / pageSize);

        // 当前页码（默认为第1页）
        let currentPage = 1;

        // 更新分页信息
        function updatePagination() {
            // 更新显示信息
            const infoElement = document.querySelector('.text-muted');
            if (infoElement) {
                const startRecord = (currentPage - 1) * pageSize + 1;
                const endRecord = Math.min(currentPage * pageSize, totalRecords);
                infoElement.textContent = `显示 ${startRecord}-${endRecord} 条，共 ${totalRecords} 条`;
            }

            // 更新分页按钮
            const pagination = document.querySelector('.pagination');
            if (pagination) {
                pagination.innerHTML = '';

                // 上一页按钮
                const prevItem = document.createElement('li');
                prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                const prevLink = document.createElement('a');
                prevLink.className = 'page-link';
                prevLink.href = '#';
                prevLink.textContent = '上一页';
                prevLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (currentPage > 1) {
                        currentPage--;
                        renderTablePage();
                        updatePagination();
                        addRowClickHandlers();
                    }
                });
                prevItem.appendChild(prevLink);
                pagination.appendChild(prevItem);

                // 页码按钮
                const maxPageButtons = 5; // 最多显示的页码按钮数
                const startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
                const endPage = Math.min(totalPages, startPage + maxPageButtons - 1);

                for (let i = startPage; i <= endPage; i++) {
                    const pageItem = document.createElement('li');
                    pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    const pageLink = document.createElement('a');
                    pageLink.className = 'page-link';
                    pageLink.href = '#';
                    pageLink.textContent = i;
                    pageLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        currentPage = i;
                        renderTablePage();
                        updatePagination();
                        addRowClickHandlers();
                    });
                    pageItem.appendChild(pageLink);
                    pagination.appendChild(pageItem);
                }

                // 下一页按钮
                const nextItem = document.createElement('li');
                nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                const nextLink = document.createElement('a');
                nextLink.className = 'page-link';
                nextLink.href = '#';
                nextLink.textContent = '下一页';
                nextLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderTablePage();
                        updatePagination();
                        addRowClickHandlers();
                    }
                });
                nextItem.appendChild(nextLink);
                pagination.appendChild(nextItem);
            }
        }

        // 渲染当前页的数据
        function renderTablePage() {
            // 清空表格
            tableBody.innerHTML = '';

            // 计算当前页的起始和结束索引
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, totalRecords);

            // 反向遍历，使最新的数据显示在前面
            for (let i = totalRecords - startIndex - 1; i >= totalRecords - endIndex; i--) {
                if (i < 0) break;

                const row = document.createElement('tr');

                // 日期
                const dateCell = document.createElement('td');
                dateCell.textContent = chartData.labels[i];
                row.appendChild(dateCell);

                // 开盘价
                const openCell = document.createElement('td');
                if (chartData.opening_prices && chartData.opening_prices[i] !== undefined) {
                    openCell.textContent = chartData.opening_prices[i].toLocaleString();
                }
                row.appendChild(openCell);

                // 最高价
                const highCell = document.createElement('td');
                if (chartData.high_prices && chartData.high_prices[i] !== undefined) {
                    highCell.textContent = chartData.high_prices[i].toLocaleString();
                }
                row.appendChild(highCell);

                // 最低价
                const lowCell = document.createElement('td');
                if (chartData.low_prices && chartData.low_prices[i] !== undefined) {
                    lowCell.textContent = chartData.low_prices[i].toLocaleString();
                }
                row.appendChild(lowCell);

                // 收盘价
                const closeCell = document.createElement('td');
                if (chartData.closing_prices[i] !== undefined) {
                    closeCell.textContent = chartData.closing_prices[i].toLocaleString();
                }
                row.appendChild(closeCell);

                // 成交量
                const volumeCell = document.createElement('td');
                if (chartData.volumes && chartData.volumes[i] !== undefined) {
                    volumeCell.textContent = chartData.volumes[i].toLocaleString();
                }
                row.appendChild(volumeCell);

                // 涨跌幅
                const changeCell = document.createElement('td');
                if (i < totalRecords - 1 && chartData.closing_prices[i] !== undefined && chartData.closing_prices[i+1] !== undefined) {
                    const change = ((chartData.closing_prices[i] - chartData.closing_prices[i+1]) / chartData.closing_prices[i+1] * 100).toFixed(2);
                    if (change > 0) {
                        changeCell.className = 'text-success';
                        changeCell.textContent = `+${change}%`;
                    } else if (change < 0) {
                        changeCell.className = 'text-danger';
                        changeCell.textContent = `${change}%`;
                    } else {
                        changeCell.className = 'text-muted';
                        changeCell.textContent = '0.00%';
                    }
                }
                row.appendChild(changeCell);

                tableBody.appendChild(row);
            }
        }

        // 初始渲染
        renderTablePage();
        updatePagination();

        // 添加行点击事件处理
        addRowClickHandlers();
    }

    // 在删除模态框显示前设置当前日期
    $('#deleteDataModal').on('show.bs.modal', function () {
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        document.getElementById('deleteDate').value = formattedDate;
        // 允许用户修改日期
        document.getElementById('deleteDate').removeAttribute('readonly');
    });
</script>
{% endblock %}